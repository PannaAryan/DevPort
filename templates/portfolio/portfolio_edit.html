{% extends 'base.html' %}

{% block title %}Edit {{ portfolio.title }} - DevPort{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ portfolio.title }}</h1>
            <p class="text-gray-600 mt-1">Build and customize your portfolio</p>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'portfolio:preview' portfolio.slug %}" 
               class="btn-secondary" target="_blank">
                <i class="fas fa-eye mr-2"></i>Preview
            </a>
            <a href="{% url 'portfolio:dashboard' %}" class="btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>Dashboard
            </a>
        </div>
    </div>
</div>

<div class="grid lg:grid-cols-4 gap-6">
    <!-- Sidebar Navigation -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-lg p-4 sticky top-6">
            <nav class="space-y-2">
                <a href="#personal-info" class="nav-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 transition duration-200">
                    <i class="fas fa-user mr-3"></i>Personal Info
                </a>
                <a href="#experience" class="nav-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 transition duration-200">
                    <i class="fas fa-briefcase mr-3"></i>Experience
                </a>
                <a href="#education" class="nav-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 transition duration-200">
                    <i class="fas fa-graduation-cap mr-3"></i>Education
                </a>
                <a href="#skills" class="nav-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 transition duration-200">
                    <i class="fas fa-code mr-3"></i>Skills
                </a>
                <a href="#projects" class="nav-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 transition duration-200">
                    <i class="fas fa-folder mr-3"></i>Projects
                </a>
                <a href="#certifications" class="nav-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 transition duration-200">
                    <i class="fas fa-certificate mr-3"></i>Certifications
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="lg:col-span-3 space-y-8">
        <!-- Personal Information Section -->
        <section id="personal-info" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-user mr-2 text-primary-600"></i>Personal Information
                </h2>
                <a href="{% url 'portfolio:profile_edit' %}" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                    <i class="fas fa-edit mr-1"></i>Edit Profile
                </a>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Basic Info</h3>
                    <p class="text-gray-600">{{ user.first_name }} {{ user.last_name }}</p>
                    <p class="text-gray-600">{{ user.email }}</p>
                    {% if user.profile.location %}
                        <p class="text-gray-600">{{ user.profile.location }}</p>
                    {% endif %}
                </div>
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Bio</h3>
                    {% if user.profile.bio %}
                        <p class="text-gray-600">{{ user.profile.bio|truncatewords:20 }}</p>
                    {% else %}
                        <p class="text-gray-400 italic">No bio added yet</p>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Experience Section -->
        <section id="experience" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-briefcase mr-2 text-primary-600"></i>Work Experience
                </h2>
                <button class="btn-primary" onclick="openModal('experienceModal')">
                    <i class="fas fa-plus mr-2"></i>Add Experience
                </button>
            </div>
            
            <div id="experience-list" class="space-y-4">
                {% for exp in experience_list %}
                    <div class="border border-gray-200 rounded-lg p-4" data-type="experience" data-id="{{ exp.id }}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-900">{{ exp.position }}</h3>
                                <p class="text-primary-600">{{ exp.company }}</p>
                                <p class="text-sm text-gray-600">
                                    {{ exp.start_date|date:"M Y" }} -
                                    {% if exp.is_current %}Present{% else %}{{ exp.end_date|date:"M Y" }}{% endif %}
                                </p>
                                <p class="text-gray-700 mt-2">{{ exp.description|truncatewords:15 }}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="text-gray-400 hover:text-blue-600" onclick="editItem('experience', {{ exp.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-gray-400 hover:text-red-600" onclick="deleteItem('experience', {{ exp.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center py-8 text-gray-500" id="empty-experience">
                        <i class="fas fa-briefcase text-4xl mb-4"></i>
                        <p>No work experience added yet</p>
                    </div>
                {% endfor %}
            </div>
        </section>

        <!-- Education Section -->
        <section id="education" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-graduation-cap mr-2 text-primary-600"></i>Education
                </h2>
                <button class="btn-primary" onclick="openModal('educationModal')">
                    <i class="fas fa-plus mr-2"></i>Add Education
                </button>
            </div>

            <div id="education-list" class="space-y-4">
                {% for edu in education_list %}
                    <div class="border border-gray-200 rounded-lg p-4" data-type="education" data-id="{{ edu.id }}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-900">{{ edu.degree }}</h3>
                                <p class="text-primary-600">{{ edu.institution }}</p>
                                {% if edu.field_of_study %}
                                    <p class="text-sm text-gray-600">{{ edu.field_of_study }}</p>
                                {% endif %}
                                <p class="text-sm text-gray-600">
                                    {{ edu.start_date|date:"Y" }} -
                                    {% if edu.end_date %}{{ edu.end_date|date:"Y" }}{% else %}Present{% endif %}
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="text-gray-400 hover:text-blue-600" onclick="editItem('education', {{ edu.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-gray-400 hover:text-red-600" onclick="deleteItem('education', {{ edu.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center py-8 text-gray-500" id="empty-education">
                        <i class="fas fa-graduation-cap text-4xl mb-4"></i>
                        <p>No education added yet</p>
                    </div>
                {% endfor %}
            </div>
        </section>

        <!-- Skills Section -->
        <section id="skills" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-code mr-2 text-primary-600"></i>Skills
                </h2>
                <button class="btn-primary" onclick="openModal('skillModal')">
                    <i class="fas fa-plus mr-2"></i>Add Skill
                </button>
            </div>

            <div id="skills-list">
                {% if skills_list %}
                    <div class="flex flex-wrap gap-2">
                        {% for skill in skills_list %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-800" data-type="skill" data-id="{{ skill.id }}">
                                {{ skill.name }}
                                <button class="ml-2 text-primary-600 hover:text-red-600" onclick="deleteItem('skill', {{ skill.id }})">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8 text-gray-500" id="empty-skills">
                        <i class="fas fa-code text-4xl mb-4"></i>
                        <p>No skills added yet</p>
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-folder mr-2 text-primary-600"></i>Projects
                </h2>
                <button class="btn-primary" onclick="openModal('projectModal')">
                    <i class="fas fa-plus mr-2"></i>Add Project
                </button>
            </div>

            <div id="projects-list" class="grid md:grid-cols-2 gap-4">
                {% for project in projects_list %}
                    <div class="border border-gray-200 rounded-lg p-4" data-type="project" data-id="{{ project.id }}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-medium text-gray-900">{{ project.name }}</h3>
                            <div class="flex space-x-2">
                                <button class="text-gray-400 hover:text-blue-600" onclick="editItem('project', {{ project.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-gray-400 hover:text-red-600" onclick="deleteItem('project', {{ project.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">{{ project.description|truncatewords:10 }}</p>
                        <div class="flex flex-wrap gap-1 mb-3">
                            {% for tech in project.get_tech_list %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">{{ tech }}</span>
                            {% endfor %}
                        </div>
                        <div class="flex space-x-2">
                            {% if project.github_url %}
                                <a href="{{ project.github_url }}" class="text-gray-600 hover:text-gray-900" target="_blank">
                                    <i class="fab fa-github"></i>
                                </a>
                            {% endif %}
                            {% if project.live_url %}
                                <a href="{{ project.live_url }}" class="text-primary-600 hover:text-primary-700" target="_blank">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <div class="col-span-2 text-center py-8 text-gray-500" id="empty-projects">
                        <i class="fas fa-folder text-4xl mb-4"></i>
                        <p>No projects added yet</p>
                    </div>
                {% endfor %}
            </div>
        </section>

        <!-- Certifications Section -->
        <section id="certifications" class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-certificate mr-2 text-primary-600"></i>Certifications
                </h2>
                <button class="btn-primary" onclick="openModal('certificationModal')">
                    <i class="fas fa-plus mr-2"></i>Add Certification
                </button>
            </div>

            <div id="certifications-list" class="space-y-4">
                {% for cert in certifications_list %}
                    <div class="border border-gray-200 rounded-lg p-4" data-type="certification" data-id="{{ cert.id }}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-900">{{ cert.name }}</h3>
                                <p class="text-primary-600">{{ cert.issuing_organization }}</p>
                                <p class="text-sm text-gray-600">
                                    Issued {{ cert.issue_date|date:"M Y" }}
                                    {% if cert.expiry_date %} â€¢ Expires {{ cert.expiry_date|date:"M Y" }}{% endif %}
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="text-gray-400 hover:text-blue-600" onclick="editItem('certification', {{ cert.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-gray-400 hover:text-red-600" onclick="deleteItem('certification', {{ cert.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center py-8 text-gray-500" id="empty-certifications">
                        <i class="fas fa-certificate text-4xl mb-4"></i>
                        <p>No certifications added yet</p>
                    </div>
                {% endfor %}
            </div>
        </section>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-2">Confirm Deletion</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="confirmationMessage">
                    Are you sure you want to delete this item? This action cannot be undone.
                </p>
            </div>
            <div class="items-center px-4 py-3 flex justify-center space-x-4">
                <button id="cancelDelete" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancel
                </button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6">
        <div class="flex items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
            <span class="ml-3 text-gray-700">Processing...</span>
        </div>
    </div>
</div>

<!-- Modals will be added here -->
{% include 'portfolio/modals.html' %}

{% endblock %}

{% block extra_js %}
<script>
    // Global variables for deletion
    let deleteType = '';
    let deleteId = '';

    // CSRF token for Django
    function getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        if (token) {
            return token.value;
        }
        // Fallback to cookie method
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }

    // Modal functionality
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');

            // Reset modal to add mode if not in edit mode
            if (!modal.hasAttribute('data-edit-id')) {
                resetModalToAddMode(modal);
            }
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');

            // Reset modal to add mode
            resetModalToAddMode(modal);
        }
    }

    // Reset modal to add mode
    function resetModalToAddMode(modal) {
        // Remove edit attributes
        modal.removeAttribute('data-edit-id');
        modal.removeAttribute('data-edit-type');

        // Reset form if exists
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
        }

        // Reset title
        const titleElement = modal.querySelector('.modal-title');
        if (titleElement) {
            const modalId = modal.id;
            const titles = {
                'experienceModal': 'Add Experience',
                'educationModal': 'Add Education',
                'projectModal': 'Add Project',
                'certificationModal': 'Add Certification',
                'skillModal': 'Add Skill'
            };
            titleElement.textContent = titles[modalId] || 'Add Item';
        }

        // Reset submit button
        const submitBtn = modal.querySelector('.submit-btn');
        if (submitBtn) {
            submitBtn.textContent = 'Add';
        }
    }

    // Show loading spinner
    function showLoading() {
        document.getElementById('loadingSpinner').classList.remove('hidden');
    }

    // Hide loading spinner
    function hideLoading() {
        document.getElementById('loadingSpinner').classList.add('hidden');
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        document.body.appendChild(notification);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Edit item function
    function editItem(type, id) {
        // Show loading while fetching data
        showLoading();

        // Fetch the item data first
        fetch(`/portfolio/ajax/${type}/get/${id}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            hideLoading();
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to fetch item data');
        })
        .then(data => {
            // Populate the modal with existing data
            populateEditModal(type, data);

            // Open the appropriate modal
            const modalMap = {
                'experience': 'experienceModal',
                'education': 'educationModal',
                'project': 'projectModal',
                'certification': 'certificationModal'
            };

            if (modalMap[type]) {
                openModal(modalMap[type]);

                // Set the modal to edit mode
                const modal = document.getElementById(modalMap[type]);
                modal.setAttribute('data-edit-id', id);
                modal.setAttribute('data-edit-type', type);

                // Change modal title to indicate editing
                const titleElement = modal.querySelector('.modal-title');
                if (titleElement) {
                    titleElement.textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                }

                // Change submit button text
                const submitBtn = modal.querySelector('.submit-btn');
                if (submitBtn) {
                    submitBtn.textContent = 'Update';
                }
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showNotification('Error loading item data. Please try again.', 'error');
        });
    }

    // Populate edit modal with existing data
    function populateEditModal(type, data) {
        const modalId = {
            'experience': 'experienceModal',
            'education': 'educationModal',
            'project': 'projectModal',
            'certification': 'certificationModal'
        }[type];

        const modal = document.getElementById(modalId);
        if (!modal) return;

        // Generic function to populate form fields
        Object.keys(data).forEach(key => {
            const input = modal.querySelector(`[name="${key}"]`);
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = data[key];
                } else {
                    input.value = data[key] || '';
                }
            }
        });
    }

    // Delete item function
    function deleteItem(type, id) {
        deleteType = type;
        deleteId = id;

        const typeNames = {
            'experience': 'work experience',
            'education': 'education',
            'skill': 'skill',
            'project': 'project',
            'certification': 'certification'
        };

        document.getElementById('confirmationMessage').textContent =
            `Are you sure you want to delete this ${typeNames[type]}? This action cannot be undone.`;

        document.getElementById('confirmationModal').classList.remove('hidden');
    }

    // Confirm deletion
    function confirmDeletion() {
        if (!deleteType || !deleteId) {
            showNotification('Error: Invalid deletion parameters', 'error');
            return;
        }

        showLoading();
        document.getElementById('confirmationModal').classList.add('hidden');

        // Make AJAX request to delete the item
        fetch(`/portfolio/ajax/${deleteType}/delete/${deleteId}/`, {
            method: 'POST',  // Changed to POST for better Django compatibility
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                '_method': 'DELETE'  // Method override
            })
        })
        .then(response => {
            hideLoading();
            if (response.ok) {
                return response.json();
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        })
        .then(data => {
            // Remove the item from the DOM
            const element = document.querySelector(`[data-type="${deleteType}"][data-id="${deleteId}"]`);
            if (element) {
                // Add fade out animation
                element.style.transition = 'opacity 0.3s ease-out';
                element.style.opacity = '0';

                setTimeout(() => {
                    element.remove();

                    // Check if section is now empty and show empty state
                    const containerMap = {
                        'certification': 'certifications-list',
                        'experience': 'experience-list',
                        'education': 'education-list',
                        'skill': 'skills-list',
                        'project': 'projects-list'
                    };

                    const container = document.getElementById(containerMap[deleteType]);
                    if (container) {
                        const items = container.querySelectorAll(`[data-type="${deleteType}"]`);

                        if (items.length === 0) {
                            showEmptyState(deleteType);
                        }
                    }
                }, 300);
            }

            const typeNames = {
                'experience': 'Work experience',
                'education': 'Education',
                'skill': 'Skill',
                'project': 'Project',
                'certification': 'Certification'
            };

            showNotification(`${typeNames[deleteType]} deleted successfully!`);
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showNotification('Error deleting item. Please try again.', 'error');
        })
        .finally(() => {
            // Reset deletion variables
            deleteType = '';
            deleteId = '';
        });
    }

    // Show empty state for section
    function showEmptyState(type) {
        const icons = {
            'experience': 'fa-briefcase',
            'education': 'fa-graduation-cap',
            'skill': 'fa-code',
            'project': 'fa-folder',
            'certification': 'fa-certificate'
        };

        const messages = {
            'experience': 'No work experience added yet',
            'education': 'No education added yet',
            'skill': 'No skills added yet',
            'project': 'No projects added yet',
            'certification': 'No certifications added yet'
        };

        const container = document.getElementById(`${type === 'certification' ? 'certifications' : type}-list`);
        const emptyHtml = `
            <div class="text-center py-8 text-gray-500" id="empty-${type === 'certification' ? 'certifications' : type}">
                <i class="fas ${icons[type]} text-4xl mb-4"></i>
                <p>${messages[type]}</p>
            </div>
        `;

        if (type === 'project') {
            container.innerHTML = `<div class="col-span-2">${emptyHtml}</div>`;
        } else {
            container.innerHTML = emptyHtml;
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Smooth scrolling for navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });

                    // Update active navigation
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-primary-100', 'text-primary-700'));
                    this.classList.add('bg-primary-100', 'text-primary-700');
                }
            });
        });

        // Confirmation modal event listeners
        document.getElementById('confirmDelete').addEventListener('click', confirmDeletion);
        document.getElementById('cancelDelete').addEventListener('click', function() {
            document.getElementById('confirmationModal').classList.add('hidden');
            deleteType = '';
            deleteId = '';
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('bg-opacity-50') && e.target.classList.contains('fixed')) {
                const modals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
                modals.forEach(modal => {
                    if (modal.id !== 'loadingSpinner') {
                        closeModal(modal.id);
                    }
                });
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close all modals on Escape
                const modals = ['confirmationModal', 'experienceModal', 'educationModal', 'skillModal', 'projectModal', 'certificationModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && !modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                    }
                });
                document.body.classList.remove('overflow-hidden');
            }
        });
    });

    // Active navigation tracking on scroll
    window.addEventListener('scroll', function() {
        const sections = ['personal-info', 'experience', 'education', 'skills', 'projects', 'certifications'];
        let current = '';

        sections.forEach(section => {
            const element = document.getElementById(section);
            if (element) {
                const rect = element.getBoundingClientRect();
                if (rect.top <= 100 && rect.bottom >= 100) {
                    current = section;
                }
            }
        });

        if (current) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-primary-100', 'text-primary-700');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('bg-primary-100', 'text-primary-700');
                }
            });
        }
    });
</script>
{% endblock %}